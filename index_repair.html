<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>남경 검수시스템 · Dashboard-보수</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#eef1f5; }

    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }

    /* KPI */
    .kpi-title{ font-size:12px; color:#64748b; font-weight:900; letter-spacing:.2px; }
    .kpi-value{ margin-top:8px; font-size:28px; font-weight:900; line-height:1; }
    .kpi-desc{ margin-top:6px; font-size:12px; color:#94a3b8; font-weight:700; }
    .kpi-warn{ border-color:#fecaca; background:#fff7f7; }
    .kpi-green{ border-color:#bbf7d0; background:#f0fdf4; }

    /* 설비 전광판 */
    .board{
      background: linear-gradient(180deg, #0b122a 0%, #111c3f 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:18px;
      box-shadow:0 10px 28px rgba(15,23,42,.18);
    }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.90);
      white-space:nowrap;
      font-weight:900;
    }
    .board-title{ font-size:13px; font-weight:900; color:rgba(255,255,255,.85); letter-spacing:.3px; }

    .board-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .board-cell{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
    }
    .board-k{ font-size:12px; font-weight:900; color:rgba(255,255,255,.70); }
    .board-v{ margin-top:8px; font-size:34px; font-weight:900; line-height:1; letter-spacing:-.6px; color:#fff; }
    .board-s{ margin-top:8px; font-size:12px; font-weight:800; color:rgba(255,255,255,.70); }

    /* 설비 하단 2칸(인보이스/국가) */
    .board-mini{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .mini-cell{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:16px;
      padding:12px;
    }
    .mini-k{ font-size:12px; font-weight:900; color:rgba(255,255,255,.70); }
    .mini-v{ margin-top:8px; font-size:18px; font-weight:900; color:#fff; line-height:1.2; }

    /* 테이블 */
    table { border-collapse: separate; border-spacing:0; }
    thead th{
      position: sticky; top:0;
      background:#f8fafc;
      z-index:1;
    }
    .td, .th{
      border-bottom:1px solid #e5e7eb;
      padding:10px 10px;
      font-size:12px;
      color:#0f172a;
      white-space:nowrap;
    }
    .th{ font-weight:900; color:#334155; }
  </style>
</head>

<body class="min-h-screen">
  <script src="nav.js"></script>

  <div class="max-w-[1700px] mx-auto pt-16 px-4 md:px-6 pb-8">
    <div class="relative">

      <!-- Overlay -->
      <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

      <!-- Sidebar (접힘) -->
      <aside id="sidebar"
        class="fixed z-50 top-0 left-0 h-full w-[270px] md:w-[290px] lg:w-[300px]
               -translate-x-full transition-transform duration-200 ease-out">
        <div class="h-full pt-16 px-3">
          <div class="bg-[#1f2a58] text-white rounded-2xl overflow-hidden shadow-sm h-[calc(100vh-5rem)]">
            <div class="px-4 py-4 border-b border-white/10">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center font-bold text-sm">NK</div>
                <div class="min-w-0">
                  <div class="text-sm font-semibold leading-5 truncate">남경 검수시스템</div>
                  <div class="text-[11px] text-white/70">Dashboard-보수</div>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-[11px] text-white/70">데이터 상태</div>
                <div class="mt-1 flex items-center justify-between">
                  <span id="dataStatus" class="text-[12px] font-semibold">대기</span>
                  <span id="dataUpdated" class="text-[11px] text-white/70">-</span>
                </div>
              </div>
            </div>

            <nav class="px-2 py-2">
              <a href="index.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">DASHBOARD</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">HOME</span>
              </a>

              <a href="index_repair.html" class="mt-1 flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10">
                <span class="text-[12px] font-semibold">DASHBOARD-보수</span>
              </a>

              <div class="mt-3 px-3 py-3 border-t border-white/10">
                <div class="text-[11px] text-white/70 leading-5">
                  · 좌측: KPI + 설비 전광판<br/>
                  · 우측: 설비작업대기 테이블
                </div>
              </div>
            </nav>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="min-w-0">

        <!-- 상단 바 -->
        <div class="mb-4 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="text-[11px] font-extrabold text-slate-500 tracking-widest">REPAIR / FACILITY</div>
              <div class="hidden md:block text-sm font-extrabold text-slate-900 truncate">
                남경 검수시스템 · DASHBOARD-보수
              </div>
            </div>

            <div class="flex items-center gap-3">
              <button id="btnSidebar"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px] font-extrabold text-slate-800 hover:bg-slate-50">
                MENU
              </button>

              <div class="text-right">
                <div id="boardClock" class="text-lg md:text-xl font-extrabold tabular-nums text-slate-900">--:--:--</div>
                <div class="text-[11px] text-slate-500">
                  마지막 갱신:
                  <span id="boardUpdated" class="font-extrabold text-sky-700">-</span>
                </div>
              </div>

              <button id="btnFullscreen"
                class="hidden md:inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] font-extrabold text-slate-800 hover:bg-slate-100">
                FULLSCREEN
              </button>
            </div>
          </div>

          <div class="mt-2 flex items-center justify-between">
            <div class="text-[11px] text-slate-500">
              자동 새로고침 <b id="boardEvery">30</b>초 · 다음 갱신까지 <b id="boardCountdown">30</b>초
            </div>
            <div id="boardPulse" class="text-[11px] font-extrabold text-emerald-700">LIVE</div>
          </div>
        </div>

        <!-- ✅ 전체 2열: LEFT(40%) / RIGHT(60%) -->
        <section class="grid grid-cols-1 xl:grid-cols-[2fr_3fr] gap-4">

          <!-- ================= LEFT ================= -->
          <div class="min-w-0">

            <!-- ✅ KPI 2x2 -->
            <div class="grid grid-cols-2 gap-3">
              <div class="card kpi-warn p-4">
                <div class="kpi-title">보수 작업량</div>
                <div class="kpi-value tabular-nums" id="k_repair_plan_total">0</div>
                <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_repair_plan_months">
                  <div>1월 0</div>
                  <div>2월 0</div>
                </div>
              </div>

              <div class="card kpi-green p-4">
                <div class="kpi-title">보수 작업 진행량</div>
                <div class="kpi-value tabular-nums" id="k_repair_done_total">0</div>
                <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_repair_done_months">
                  <div>1월 0</div>
                  <div>2월 0</div>
                </div>
              </div>

              <div class="card p-4">
                <div class="kpi-title">일평균 작업량</div>
                <div class="kpi-value tabular-nums" id="k_avg_general">0</div>
                <div class="kpi-desc">record!G 평균</div>
              </div>

              <div class="card p-4">
                <div class="kpi-title">설비 평균 작업량</div>
                <div class="kpi-value tabular-nums" id="k_avg_facility">0</div>
                <div class="kpi-desc">record!F 평균</div>
              </div>
            </div>

            <!-- 구분선 -->
            <div class="my-4 border-t border-slate-200"></div>

            <!-- ✅ 설비 전광판 -->
            <div class="board">
              <div class="flex items-center justify-between">
                <div class="board-title">설비</div>
                <span class="pill">LIVE</span>
              </div>

              <div class="board-grid">
                <div class="board-cell">
                  <div class="board-k">설비 작업대기</div>
                  <div class="board-v tabular-nums" id="fac_wait">0</div>
                  <div class="board-s">오늘 N열 합계</div>
                </div>

                <div class="board-cell">
                  <div class="board-k">작업진행</div>
                  <div class="board-v tabular-nums" id="fac_run">0</div>
                  <div class="board-s">오늘 C=1 인 N열 합계</div>
                </div>

                <div class="board-cell">
                  <div class="board-k">진행률</div>
                  <div class="board-v tabular-nums"><span id="fac_pct">0</span>%</div>
                  <div class="board-s">작업진행 / 작업대기</div>
                </div>
              </div>

              <div class="board-mini">
                <div class="mini-cell">
                  <div class="mini-k">인보이스</div>
                  <div class="mini-v" id="fac_inv">-</div>
                </div>
                <div class="mini-cell">
                  <div class="mini-k">국가</div>
                  <div class="mini-v" id="fac_country">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ================= RIGHT ================= -->
          <div class="card overflow-hidden min-w-0">
            <div class="px-4 py-3 border-b border-slate-200 bg-white flex items-center justify-between">
              <div>
                <div class="text-[12px] font-extrabold text-slate-900">설비작업대기</div>
                <div class="text-[11px] text-slate-500 font-semibold">
                  인보이스 · 상품코드 · 박스번호 · 품명 · 외박스 · 제품 · 합계
                </div>
              </div>

              <div class="flex items-center gap-2">
                <input id="qWait"
                  class="w-[220px] md:w-[280px] rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] font-semibold outline-none focus:bg-white"
                  placeholder="검색(인보이스/박스/상품코드/품명)" />
                <button id="btnRefresh"
                  class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px] font-extrabold text-slate-800 hover:bg-slate-50">
                  새로고침
                </button>
              </div>
            </div>

            <div class="px-4 py-2 bg-slate-50 border-b border-slate-200 text-[11px] text-slate-600 flex items-center justify-between">
              <div>총 <b class="text-slate-900" id="waitCount">0</b> 건</div>
              <div class="font-extrabold text-slate-500" id="waitHint">대기</div>
            </div>

            <div class="max-h-[720px] overflow-auto">
              <table class="w-full">
                <thead>
                  <tr>
                    <th class="th text-left">인보이스</th>
                    <th class="th text-left">상품코드</th>
                    <th class="th text-left">박스번호</th>
                    <th class="th text-left">품명</th>
                    <th class="th text-right">외박스</th>
                    <th class="th text-right">제품</th>
                    <th class="th text-right">합계</th>
                  </tr>
                </thead>
                <tbody id="waitTbody">
                  <tr>
                    <td class="td text-slate-400" colspan="7">데이터 로딩 후 표시됩니다…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </section>

      </main>
    </div>
  </div>

  <script type="module">
    import { DataHub } from "./datahub.js";

    /* ==========================
       ✅ URL (registry + direct fallback)
    ========================== */
    const URL_REGISTRY =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=1348530486&single=true&output=csv";

    // facility(enabled=0)이라 DataHub로 안 들어올 수 있어 → 직접 로드 fallback
    const URL_FACILITY =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=743719058&single=true&output=csv";

    // record도 enabled가 비어있을 수 있어 → 직접 로드 fallback
    const URL_RECORD =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=184086545&single=true&output=csv";

    const statusEl = document.getElementById("dataStatus");
    const updatedEl = document.getElementById("dataUpdated");
    const boardUpdatedEl = document.getElementById("boardUpdated");

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(v);
    };

    /* ==========================
       ✅ 공통 유틸
    ========================== */
    const fmtKR = new Intl.NumberFormat("ko-KR");

    function norm(v) {
      return String(v ?? "").replace(/\r/g, "").trim();
    }
    function toNum(v) {
      const s = String(v ?? "").replace(/,/g, "").replace(/[^\d.-]/g, "").trim();
      if (!s) return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    // KST YYYY-MM-DD
    const KST_FMT = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Seoul",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });
    function getKRYMD(offsetDays = 0) {
      return KST_FMT.format(new Date(Date.now() + offsetDays * 86400_000));
    }

    // 문자열 날짜 → YYYY-MM-DD
    function toYMD(s) {
      s = norm(s);
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      m = s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
      if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

      m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
      if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

      m = s.match(/^(\d{1,2})\/(\d{1,2})$/);
      if (m) {
        const year = getKRYMD(0).slice(0,4);
        return `${year}-${String(m[1]).padStart(2,"0")}-${String(m[2]).padStart(2,"0")}`;
      }
      return s;
    }

    // YYYY-MM
    function ymFromYMD(ymd){ return ymd.slice(0,7); }
    function shiftYM(ym, diff){
      const y = Number(ym.slice(0,4));
      const m = Number(ym.slice(5,7));
      const d = new Date(Date.UTC(y, m - 1 + diff, 1));
      const yy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,"0");
      return `${yy}-${mm}`;
    }
    function monthLabel(ym){ return `${Number(ym.slice(5,7))}월`; }

    async function fetchCsvRowsDirect(url){
      const u = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(u, { cache: "no-store" });
      if (!res.ok) throw new Error(`CSV HTTP ${res.status}`);
      const text = await res.text();
      // DataHub parseCsv와 동일한 방식(간단 CSV)
      const rows = [];
      let row = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i + 1] === '"') { field += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (ch === "," && !inQuotes) { row.push(field); field=""; continue; }
        if (ch === "\n" && !inQuotes) {
          row.push(field); field="";
          rows.push(row.map(v => (v ?? "").replace(/\r/g, "")));
          row = [];
          continue;
        }
        field += ch;
      }
      if (field.length || row.length) {
        row.push(field);
        rows.push(row.map(v => (v ?? "").replace(/\r/g, "")));
      }
      return rows.filter(r => r.some(c => String(c ?? "").trim() !== ""));
    }

    function flashUpdated(text){
      if (updatedEl) updatedEl.textContent = text || "-";
      if (boardUpdatedEl) boardUpdatedEl.textContent = text || "-";
    }

    /* ==========================
       ✅ 1) 보수 작업량 (sap_item) - 기존 Dashboard와 동일
       - E(4): 날짜
       - R(17): 장수
       - 현재월 + 다음달
    ========================== */
    function calcIssue(hub){
      const COL_DATE = 4;   // E
      const COL_VAL  = 17;  // R
      const ymNow  = ymFromYMD(getKRYMD(0));
      const ymNext = shiftYM(ymNow, +1);

      const rows = hub?.sources?.sap_item?.rows || [];
      let sumNow=0, sumNext=0;

      for(const r of rows){
        const d = toYMD(r?.[COL_DATE]);
        if(!d || d.includes("날짜")) continue;
        const ym = ymFromYMD(d);
        const val = toNum(r?.[COL_VAL]);
        if(ym===ymNow) sumNow += val;
        else if(ym===ymNext) sumNext += val;
      }

      setText("k_repair_plan_total", fmtKR.format(sumNow));

      const listEl = document.getElementById("k_repair_plan_months");
      if(listEl){
        listEl.innerHTML = `
          <div>${monthLabel(ymNow)} ${fmtKR.format(sumNow)}</div>
          <div>${monthLabel(ymNext)} ${fmtKR.format(sumNext)}</div>
        `;
      }
    }

    /* ==========================
       ✅ 2) 보수 작업 진행량(완료) (repair) - 기존 Dashboard와 동일
       - A(0): 날짜
       - N(13): 수량 합
       - R(17): 상태(완료 포함)
       - 현재월 + 다음달
    ========================== */
    function calcRepairDone(hub){
      const COL_DATE   = 0;   // A
      const COL_QTY    = 13;  // N
      const COL_STATUS = 17;  // R

      const ymNow  = getKRYMD(0).slice(0,7);
      const ymNext = shiftYM(ymNow, +1);

      const rows = hub?.sources?.repair?.rows || [];
      let doneNow=0, doneNext=0;

      for(const r of rows){
        const d = toYMD(r?.[COL_DATE]);
        if(!d || d.includes("날짜")) continue;
        const ym = d.slice(0,7);
        if(ym!==ymNow && ym!==ymNext) continue;

        const st = String(r?.[COL_STATUS] ?? "").replace(/\r|\n/g,"").replace(/\s/g,"");
        if(!st.includes("완료")) continue;

        const qty = toNum(r?.[COL_QTY]);
        if(!qty) continue;

        if(ym===ymNow) doneNow += qty;
        else doneNext += qty;
      }

      setText("k_repair_done_total", fmtKR.format(doneNow));

      const listEl = document.getElementById("k_repair_done_months");
      if(listEl){
        listEl.innerHTML = `
          <div>${Number(ymNow.slice(5,7))}월 ${fmtKR.format(doneNow)}</div>
          <div>${Number(ymNext.slice(5,7))}월 ${fmtKR.format(doneNext)}</div>
        `;
      }
    }

    /* ==========================
       ✅ 3) record 평균
       - 일평균 작업량: record G열(6) 평균 (G3~)
       - 설비 평균 작업량: record F열(5) 평균 (F3~)
    ========================== */
    function calcRecordAverages(recordRows){
      // recordRows: CSV 전체 rows (헤더 포함)
      const rows = recordRows || [];
      const start = 2; // 0-based, row3부터
      const COL_F = 5; // F
      const COL_G = 6; // G

      let sumF=0, cntF=0;
      let sumG=0, cntG=0;

      for(let i=start; i<rows.length; i++){
        const r = rows[i];
        if(!r) continue;

        const f = toNum(r[COL_F]);
        const g = toNum(r[COL_G]);

        // "값있는 곳까지" = 빈칸 제외 (0도 값으로 볼지 애매하지만, 보통 0은 의미 없어서 제외)
        if (norm(r[COL_F]) !== "" && f !== 0) { sumF += f; cntF++; }
        if (norm(r[COL_G]) !== "" && g !== 0) { sumG += g; cntG++; }
      }

      const avgF = cntF ? (sumF / cntF) : 0;
      const avgG = cntG ? (sumG / cntG) : 0;

      setText("k_avg_general", fmtKR.format(Math.round(avgG)));
      setText("k_avg_facility", fmtKR.format(Math.round(avgF)));
    }

    /* ==========================
       ✅ 4) facility 오늘 데이터
       - 오늘(B열) 기준
       - 작업유무(C열) : 1이면 진행
       - 표 컬럼:
         인보이스 A(0)
         상품코드 E(4)
         박스번호 F(5)
         품명 G(6)
         외박스 L(11)
         제품   M(12)
         합계   N(13)
       - 설비 작업대기: 오늘 N열 합계(전체)
       - 작업진행: 오늘 + C=1 인 N열 합계
       - 진행률: 작업진행 / 작업대기
    ========================== */
    function calcFacilityToday(fRows){
      const rows = fRows || [];
      const start = 2; // row3부터 (헤더 1~2줄 있다고 가정)
      const today = getKRYMD(0);

      // col index
      const COL_INV = 0;   // A
      const COL_DATE = 1;  // B
      const COL_WORK = 2;  // C (작업유무 1)
      const COL_CODE = 4;  // E
      const COL_BOX  = 5;  // F
      const COL_NAME = 6;  // G
      const COL_OUT  = 11; // L
      const COL_IN   = 12; // M
      const COL_SUM  = 13; // N

      let totalSum = 0;
      let runSum = 0;

      const todayList = [];

      for(let i=start; i<rows.length; i++){
        const r = rows[i];
        if(!r) continue;

        const ymd = toYMD(r[COL_DATE]);
        if(ymd !== today) continue;

        const work = norm(r[COL_WORK]);
        const nsum = toNum(r[COL_SUM]);

        totalSum += nsum;
        if (work === "1") runSum += nsum;

        todayList.push({
          inv: norm(r[COL_INV]),
          work,
          code: norm(r[COL_CODE]),
          box:  norm(r[COL_BOX]),
          name: norm(r[COL_NAME]),
          outBox: toNum(r[COL_OUT]),
          inProd: toNum(r[COL_IN]),
          sum: nsum,
          raw: r,
        });
      }

      setText("fac_wait", fmtKR.format(Math.round(totalSum)));
      setText("fac_run", fmtKR.format(Math.round(runSum)));

      const pct = totalSum > 0 ? Math.round((runSum / totalSum) * 100) : 0;
      setText("fac_pct", pct);

      // 전광판 하단 인보이스/국가: 오늘 중 "미진행(work!=1)" 1건 우선, 없으면 첫 건
      const pick = todayList.find(x => x.work !== "1") || todayList[0];
      setText("fac_inv", pick?.inv || "-");
      // country 컬럼은 facility에 명시 없어서, 없으면 "-" (나중에 국가 컬럼 생기면 여기만 index 바꾸면 됨)
      setText("fac_country", "-");

      return todayList;
    }

    function renderFacilityTable(list){
      const tbody = document.getElementById("waitTbody");
      const countEl = document.getElementById("waitCount");
      const hintEl = document.getElementById("waitHint");
      if(!tbody) return;

      const q = norm(document.getElementById("qWait")?.value).toLowerCase();

      const filtered = (list || []).filter(x => {
        if(!q) return true;
        return (
          (x.inv||"").toLowerCase().includes(q) ||
          (x.code||"").toLowerCase().includes(q) ||
          (x.box||"").toLowerCase().includes(q) ||
          (x.name||"").toLowerCase().includes(q)
        );
      });

      if(countEl) countEl.textContent = String(filtered.length);
      if(hintEl) hintEl.textContent = q ? `검색: ${q}` : "오늘 기준";

      if(filtered.length === 0){
        tbody.innerHTML = `<tr><td class="td text-slate-400" colspan="7">오늘 데이터 없음</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(x => `
        <tr>
          <td class="td text-left">${x.inv || "-"}</td>
          <td class="td text-left">${x.code || "-"}</td>
          <td class="td text-left">${x.box || "-"}</td>
          <td class="td text-left">${x.name || "-"}</td>
          <td class="td text-right tabular-nums">${fmtKR.format(x.outBox || 0)}</td>
          <td class="td text-right tabular-nums">${fmtKR.format(x.inProd || 0)}</td>
          <td class="td text-right tabular-nums font-extrabold">${fmtKR.format(x.sum || 0)}</td>
        </tr>
      `).join("");
    }

    /* ==========================
       ✅ 데이터 갱신
    ========================== */
    async function refreshData(){
      try{
        const REG_URL = URL_REGISTRY + (URL_REGISTRY.includes("?") ? "&" : "?") + "t=" + Date.now();

        const hub = await DataHub.loadAll(REG_URL, (p) => {
          if (!statusEl) return;

          if (p.phase === "registry") {
            statusEl.textContent =
              p.status === "ok" ? `Registry OK (${p.count}개)` :
              p.status === "cached" ? "Registry 캐시 사용" :
              p.status === "loading" ? "Registry 로딩..." :
              "Registry 오류";
          }
          if (p.phase === "source") {
            if (p.status === "loading") statusEl.textContent = `${p.name} 로딩...`;
            if (p.status === "ok") statusEl.textContent = `${p.name} OK (${p.rows}행)`;
            if (p.status === "error") statusEl.textContent = `${p.name} 오류`;
          }
        });

        const loadedAt = hub.meta.loadedAt.replace("T"," ").slice(0,19);
        flashUpdated(loadedAt);

        // ✅ KPI(기존 로직)
        calcIssue(hub);
        calcRepairDone(hub);

        // ✅ record 평균: hub에 없으면 direct 로드
        let recordRows = hub?.sources?.record?.rows;
        if (!recordRows || recordRows.length === 0) {
          recordRows = await fetchCsvRowsDirect(URL_RECORD);
        }
        calcRecordAverages(recordRows);

        // ✅ facility 오늘: hub에 없으면 direct 로드 (enabled=0 대비)
        let facilityRows = hub?.sources?.facility?.rows;
        if (!facilityRows || facilityRows.length === 0) {
          facilityRows = await fetchCsvRowsDirect(URL_FACILITY);
        }
        const todayList = calcFacilityToday(facilityRows);
        window.__facility_today_list = todayList;
        renderFacilityTable(todayList);

        return hub;
      } catch(e){
        console.error("refreshData error:", e);
        if (statusEl) statusEl.textContent = "오류: " + (e?.message || e);
        return null;
      }
    }

    /* ==========================
       ✅ UI: Sidebar/Clock/Fullscreen/검색
    ========================== */
    // Sidebar
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");
    const btnSidebar = document.getElementById("btnSidebar");
    const openSidebar = () => { sidebar?.classList.remove("-translate-x-full"); overlay?.classList.remove("hidden"); document.body.style.overflow="hidden"; };
    const closeSidebar = () => { sidebar?.classList.add("-translate-x-full"); overlay?.classList.add("hidden"); document.body.style.overflow=""; };
    btnSidebar?.addEventListener("click", () => sidebar?.classList.contains("-translate-x-full") ? openSidebar() : closeSidebar());
    overlay?.addEventListener("click", closeSidebar);
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeSidebar(); });

    // Clock
    const clockEl = document.getElementById("boardClock");
    const KST_TIME_FMT = new Intl.DateTimeFormat("ko-KR", { timeZone:"Asia/Seoul", hour:"2-digit", minute:"2-digit", second:"2-digit" });
    const tickClock = () => { if(clockEl) clockEl.textContent = KST_TIME_FMT.format(new Date()); };
    tickClock(); setInterval(tickClock, 1000);

    // Fullscreen
    document.getElementById("btnFullscreen")?.addEventListener("click", async () => {
      try{
        if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
        else await document.exitFullscreen();
      }catch{}
    });

    // 검색
    document.getElementById("qWait")?.addEventListener("input", () => {
      renderFacilityTable(window.__facility_today_list || []);
    });

    /* ==========================
       ✅ 전광판 폴링(리로드X)
    ========================== */
    const REFRESH_SEC = 30;
    const cdEl = document.getElementById("boardCountdown");
    const everyEl = document.getElementById("boardEvery");
    const pulseEl = document.getElementById("boardPulse");
    const btnRefresh = document.getElementById("btnRefresh");

    if (everyEl) everyEl.textContent = String(REFRESH_SEC);

    btnRefresh?.addEventListener("click", async () => {
      await refreshData();
    });

    // 최초 로드
    await refreshData();

    // 카운트 + 갱신
    let remain = REFRESH_SEC;
    if (cdEl) cdEl.textContent = String(remain);

    setInterval(async () => {
      remain--;
      if (remain <= 0) {
        remain = REFRESH_SEC;
        await refreshData();
      }
      if (cdEl) cdEl.textContent = String(remain);
      if (pulseEl) pulseEl.style.opacity = (remain % 2 === 0 ? "1" : ".65");
    }, 1000);
  </script>
</body>
</html>
