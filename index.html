<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚¨ê²½ ê²€ìˆ˜ì‹œìŠ¤í…œ Â· Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#eef1f5; }
    .no-scrollbar::-webkit-scrollbar{ width:0; height:0; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    /* ê³µí†µ KPI */
    .kpi-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .kpi-title{ font-size:12px; color:#64748b; font-weight:700; letter-spacing:.2px; }
    .kpi-value{ margin-top:8px; font-size:28px; font-weight:900; line-height:1; }
    .kpi-desc{ margin-top:6px; font-size:12px; color:#94a3b8; }
    .kpi-warn{ border-color:#fecaca; background:#fff7f7; }

    /* ìƒì°¨ ì¹´ë“œ (ì „ê´‘íŒ ëŠë‚Œ) */
    .dock-card{
      background: linear-gradient(180deg, #0b122a 0%, #111c3f 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:18px;
      box-shadow:0 10px 28px rgba(15,23,42,.20);
    }
    .dock-title{ font-size:13px; color:rgba(255,255,255,.82); font-weight:900; letter-spacing:.3px; }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.88);
      white-space:nowrap;
      font-weight:800;
    }
    .dock-row{ margin-top:10px; display:flex; align-items:end; justify-content:space-between; gap:10px; }
    .dock-percent{ font-size:40px; font-weight:900; line-height:1; letter-spacing:-.6px; }
    .dock-sub{ font-size:13px; color:rgba(255,255,255,.75); font-weight:700; }

    .dock-owner{
      margin-top:10px;
      font-size:18px;            /* âœ… ë‹´ë‹¹ì í¬ê²Œ */
      font-weight:900;
      letter-spacing:-.2px;
      color:rgba(255,255,255,.95);
    }

    /* âœ… 2x3 ë°°ì—´ */
    .dock-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      font-size:12px;
      color:rgba(255,255,255,.82);
    }
    .dock-grid .k{ color:rgba(255,255,255,.55); font-weight:800; }
    .dock-grid .v{ font-weight:900; color:rgba(255,255,255,.95); }

    /* ì˜¤ëŠ˜/ë‚´ì¼ ì»¨í…Œì´ë„ˆ ì¹´ë“œ ë‚´ë¶€ ë¼ì¸ */
    /* ì»¨í…Œì´ë„ˆ 20/40 ì¹© */
.subline{
  margin-top:8px;
  font-size:14px;
  color:#0f172a;
  display:flex;
  gap:12px;
  font-weight:900;
}
.subline .chip{
  padding:4px 10px;
  border-radius:999px;
  background:#f1f5f9;
  border:1px solid #e2e8f0;
  font-variant-numeric: tabular-nums;
}
.subline .chip b{ font-weight:900; }

/* ë³´ìˆ˜ ì§„í–‰ëŸ‰ ì¹´ë“œ ì—°ì´ˆë¡ */
.kpi-green{
  border-color:#bbf7d0;
  background:#f0fdf4;
}

    .subline span:last-child{ font-variant-numeric: tabular-nums; color:#0f172a; font-weight:900; }
  </style>
</head>

<body class="min-h-screen">
  <script src="nav.js"></script>

  <div class="max-w-[1700px] mx-auto pt-16 px-4 md:px-6 pb-8">
    <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-5">

      <!-- =======================
           Left Sidebar
           ======================= -->
      <aside class="lg:sticky lg:top-[76px] h-fit">
        <div class="bg-[#1f2a58] text-white rounded-2xl overflow-hidden shadow-sm">
          <div class="px-4 py-4 border-b border-white/10">
            <div class="flex items-center gap-2">
              <div class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center font-bold text-sm">NK</div>
              <div class="min-w-0">
                <div class="text-sm font-semibold leading-5 truncate">ë‚¨ê²½ ê²€ìˆ˜ì‹œìŠ¤í…œ</div>
                <div class="text-[11px] text-white/70">ë‚¨ê²½ Dashboard</div>
              </div>
            </div>

            <div class="mt-3">
              <div class="text-[11px] text-white/70">ë°ì´í„° ìƒíƒœ</div>
              <div class="mt-1 flex items-center justify-between">
                <span id="dataStatus" class="text-[12px] font-semibold">ëŒ€ê¸°</span>
                <span id="dataUpdated" class="text-[11px] text-white/70">-</span>
              </div>
            </div>
          </div>

          <nav class="px-2 py-2">
            <a href="index.html" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10">
              <span class="text-[12px] font-semibold">DASHBOARD</span>
            </a>

            <a href="index_repair.html" class="mt-1 flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
              <span class="text-[12px]">DASHBOARD-ë³´ìˆ˜</span>
              <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
            </a>

            <div class="mt-2 space-y-1">
              <a href="scan.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ìƒì°¨ ìŠ¤ìº”</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-sky-400/20 text-sky-200 border border-sky-300/20">RUN</span>
              </a>

              <a href="IN.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ì…ê³ ê²€ìˆ˜</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
              </a>

              <a href="OUT.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ì¶œê³ ê²€ìˆ˜</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
              </a>

              <a href="index_shipping.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ì¶œê³ ì •ë³´</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
              </a>

              <a href="index_stock.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ì¬ê³ ì¡°íšŒ</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
              </a>

              <a href="index_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ê²°í’ˆì¡°íšŒ</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-rose-400/20 text-rose-200 border border-rose-300/20">ISSUE</span>
              </a>

              <a href="detail_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ì „ì²´ê²°í’ˆ</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">LIST</span>
              </a>

              <a href="index_repair.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">ë³´ìˆ˜ì‘ì—…</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
              </a>
            </div>

            <div class="mt-3 px-3 py-3 border-t border-white/10">
              <div class="text-[11px] text-white/70 leading-5">
                Â·  Dashboard <br/>
                Â· ìƒì°¨ ìŠ¤ìº” ì—°ë™ ì˜ˆì •(ì§„í–‰ë¥ /ì¸ë³´ì´ìŠ¤/êµ­ê°€/PT/CBM/í’ˆëª©/ì‹œê°„/ë‹´ë‹¹)
              </div>
            </div>
          </nav>
        </div>
      </aside>

      <!-- =======================
           Main
           ======================= -->
      <main class="min-w-0">

        <div class="flex items-end justify-between gap-3 mb-4">
          <div>
            <div class="text-[12px] text-slate-500 font-semibold tracking-wide">DASHBOARD</div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900">
              ìƒì°¨ ì§„í–‰ í˜„í™© Â· ë³´ìˆ˜ì‘ì—…
            </div>
          </div>
        </div>

        <!-- âœ… ìƒë‹¨ 4ì¹¸: A / ì´ë™ / B-1 / B-2 (ëª¨ë‘ ë™ì¼ êµ¬ì„±) -->
        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-5">

          <!-- A -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">A ìƒì°¨ ì§„í–‰í˜„í™©</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_a_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_a_done">0</span> / <span id="dock_a_total">0</span></div>
            </div>
            <div class="dock-owner">ë‹´ë‹¹ì - <span id="dock_a_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">ì¸ë³´ì´ìŠ¤</span> <span class="v" id="dock_a_inv">-</span></div>
              <div><span class="k">êµ­ê°€</span> <span class="v" id="dock_a_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_a_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_a_cbm">-</span></div>
              <div><span class="k">í’ˆëª©</span> <span class="v" id="dock_a_item">-</span></div>
              <div><span class="k">ìƒì°¨ì‹œê°„</span> <span class="v" id="dock_a_time">-</span></div>
            </div>
          </div>

          <!-- ì´ë™ -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">ì´ë™ ìƒì°¨ ì§„í–‰í˜„í™©</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_m_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_m_done">0</span> / <span id="dock_m_total">0</span></div>
            </div>
            <div class="dock-owner">ë‹´ë‹¹ì - <span id="dock_m_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">ì¸ë³´ì´ìŠ¤</span> <span class="v" id="dock_m_inv">-</span></div>
              <div><span class="k">êµ­ê°€</span> <span class="v" id="dock_m_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_m_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_m_cbm">-</span></div>
              <div><span class="k">í’ˆëª©</span> <span class="v" id="dock_m_item">-</span></div>
              <div><span class="k">ìƒì°¨ì‹œê°„</span> <span class="v" id="dock_m_time">-</span></div>
            </div>
          </div>

          <!-- B-1 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-1 ìƒì°¨ ì§„í–‰í˜„í™©</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b1_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b1_done">0</span> / <span id="dock_b1_total">0</span></div>
            </div>
            <div class="dock-owner">ë‹´ë‹¹ì - <span id="dock_b1_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">ì¸ë³´ì´ìŠ¤</span> <span class="v" id="dock_b1_inv">-</span></div>
              <div><span class="k">êµ­ê°€</span> <span class="v" id="dock_b1_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b1_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b1_cbm">-</span></div>
              <div><span class="k">í’ˆëª©</span> <span class="v" id="dock_b1_item">-</span></div>
              <div><span class="k">ìƒì°¨ì‹œê°„</span> <span class="v" id="dock_b1_time">-</span></div>
            </div>
          </div>

          <!-- B-2 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-2 ìƒì°¨ ì§„í–‰í˜„í™©</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b2_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b2_done">0</span> / <span id="dock_b2_total">0</span></div>
            </div>
            <div class="dock-owner">ë‹´ë‹¹ì - <span id="dock_b2_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">ì¸ë³´ì´ìŠ¤</span> <span class="v" id="dock_b2_inv">-</span></div>
              <div><span class="k">êµ­ê°€</span> <span class="v" id="dock_b2_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b2_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b2_cbm">-</span></div>
              <div><span class="k">í’ˆëª©</span> <span class="v" id="dock_b2_item">-</span></div>
              <div><span class="k">ìƒì°¨ì‹œê°„</span> <span class="v" id="dock_b2_time">-</span></div>
            </div>
          </div>

        </section>

        <!-- ì•„ë˜ KPIë“¤ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì¨ë„ ë¨(í•„ìš”í•˜ë©´ ë‹¤ì‹œ ì¡°ì •) -->
<section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
  <div class="kpi-card">
    <div class="kpi-title">ì˜¤ëŠ˜ ì»¨í…Œì´ë„ˆ</div>
    <div class="kpi-value tabular-nums" id="k_today_exp">0</div>

    <div class="subline">
      <span class="chip">20pt- <b id="k_today_20">0</b></span>
      <span class="chip">40pt- <b id="k_today_40">0</b></span>
    </div>

    <div class="kpi-desc">ìˆ˜ì¶œ ì‘ì—…ì˜ë¢°ì„œ</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-title">ì˜¤ëŠ˜ LCL</div>
    <div class="kpi-value tabular-nums" id="k_today_lcl">0</div>
    <div class="kpi-desc">ë°°ì†¡ ì˜ë¢°ì„œ</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-title">ë‚´ì¼ ì»¨í…Œì´ë„ˆ</div>
    <div class="kpi-value tabular-nums" id="k_tom_exp">0</div>

    <div class="subline">
      <span class="chip">20pt- <b id="k_tom_20">0</b></span>
      <span class="chip">40pt- <b id="k_tom_40">0</b></span>
    </div>

    <div class="kpi-desc">ìˆ˜ì¶œ ì‘ì—…ì˜ë¢°ì„œ</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-title">ë‚´ì¼ LCL</div>
    <div class="kpi-value tabular-nums" id="k_tom_lcl">0</div>
    <div class="kpi-desc">ë°°ì†¡ ì˜ë¢°ì„œ</div>
  </div>
</section>

<!-- âœ… 2ë²ˆì§¸ ì¤„ KPI (ì •ë¦¬ë³¸) -->
<section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">

  <!-- âœ… ë³´ìˆ˜ ì‘ì—…ëŸ‰ (sap_item) : ì—°í•œ ë¹¨ê°• -->
  <div class="kpi-card kpi-warn">
    <div class="kpi-title">ë³´ìˆ˜ ì‘ì—…ëŸ‰</div>
    <div class="kpi-value tabular-nums" id="k_issue">0</div>

    <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_issue_month_list">
      <div>1ì›” 0</div>
      <div>2ì›” 0</div>
    </div>
  </div>

  <!-- âœ… ë³´ìˆ˜ ì‘ì—… ì§„í–‰ëŸ‰(ì™„ë£Œ) (repair) : ì—°í•œ ì´ˆë¡ -->
  <div class="kpi-card kpi-green">
    <div class="kpi-title">ë³´ìˆ˜ ì‘ì—… ì§„í–‰ëŸ‰</div>
    <div class="kpi-value tabular-nums" id="k_repair_done">0</div>

    <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_repair_done_list">
      <div>1ì›” 0</div>
      <div>2ì›” 0</div>
    </div>
  </div>

  <!-- ì¬ê³  -->
  <div class="kpi-card">
    <div class="kpi-title">ì¬ê³ </div>
    <div class="kpi-value tabular-nums" id="k_inventory">-</div>
    <div class="kpi-desc">WMS / SAP</div>
  </div>

  <!-- ìœ í†µê¸°í•œ -->
  <div class="kpi-card">
    <div class="kpi-title">ìœ í†µê¸°í•œ</div>
    <div class="kpi-value tabular-nums" id="k_expiry">-</div>
    <div class="kpi-desc">ì£¼ì˜ / ìœ„í—˜</div>
  </div>

</section>


      </main>
    </div>
  </div>

  <script type="module">
    import { DataHub } from "./datahub.js";

    const URL_REGISTRY =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=1348530486&single=true&output=csv";

    const MAP_SAPDOC = { dateIdx: 2, typeIdx: 7 };

    function getKRDate(offset = 0) {
      const now = new Date();
      const kr = new Date(now.getTime() + 9 * 3600000 + offset * 86400000);
      return kr.toISOString().slice(0, 10);
    }

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(v);
    };

    const statusEl = document.getElementById("dataStatus");
    const updatedEl = document.getElementById("dataUpdated");

    const hub = await DataHub.loadAll(URL_REGISTRY, (p) => {
      if (!statusEl) return;
      if (p.phase === "registry") {
        statusEl.textContent =
          p.status === "ok" ? `Registry OK (${p.count}ê°œ)` :
          p.status === "cached" ? "Registry ìºì‹œ ì‚¬ìš©" :
          p.status === "loading" ? "Registry ë¡œë”©..." : "Registry ì˜¤ë¥˜";
      }
      if (p.phase === "source") {
        if (p.status === "loading") statusEl.textContent = `${p.name} ë¡œë”©...`;
        if (p.status === "ok") statusEl.textContent = `${p.name} OK (${p.rows}í–‰)`;
        if (p.status === "error") statusEl.textContent = `${p.name} ì˜¤ë¥˜`;
      }
    });

    const loadedAt = hub.meta.loadedAt.replace("T"," ").slice(0,19);
    if (updatedEl) updatedEl.textContent = loadedAt;

   /* ==========================
   âœ… sap_doc ê¸°ë°˜ ì˜¤ëŠ˜/ë‚´ì¼ ì¶œê³  ì§‘ê³„ (KST ê³ ì • / ë‚ ì§œ í¬ë§· ë³´ì •)
   - Dì—´: ì¶œê³ ì¼
   - Hì—´: ë¶„ë¥˜ (ìˆ˜ì¶œ ì‘ì—…ì˜ë¢°ì„œ / ë°°ì†¡ ì˜ë¢°ì„œ)
   - Iì—´: ì»¨í…Œì´ë„ˆ íƒ€ì… (ì• 2ìë¦¬ 20 / 40)
========================== */

const COL_SHIP_DATE = 3;  // D
const COL_CLASSIFY  = 7;  // H
const COL_TYPE      = 8;  // I

const KST_FMT = new Intl.DateTimeFormat("en-CA", {
  timeZone: "Asia/Seoul",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
});

// âœ… í•œêµ­ ë‚ ì§œ(YYYY-MM-DD) â€” ë¸Œë¼ìš°ì € íƒ€ì„ì¡´ê³¼ ë¬´ê´€í•˜ê²Œ KSTë¡œ ê³„ì‚°
function getKRYMD(offsetDays = 0) {
  const base = new Date(Date.now() + offsetDays * 86400_000);
  return KST_FMT.format(base); // en-CA => YYYY-MM-DD
}

function norm(v) {
  return String(v ?? "").replace(/\r/g, "").trim();
}

// âœ… ì¶œê³ ì¼ì„ YYYY-MM-DDë¡œ ì •ê·œí™” (2025. 12. 1 / 2025-12-01 / 2025/12/01 ëª¨ë‘ ëŒ€ì‘)
function toYMD(s) {
  s = norm(s);
  if (!s) return "";

  // ì´ë¯¸ YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // YYYY.MM.DD or YYYY. M. D
  let m = s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})$/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2, "0")}-${String(m[3]).padStart(2, "0")}`;

  // YYYY/MM/DD or YYYY/M/D
  m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2, "0")}-${String(m[3]).padStart(2, "0")}`;

  // MM/DD (ì—°ë„ ì—†ìœ¼ë©´ KST ê¸°ì¤€ ì˜¬í•´ë¡œ ê°€ì •)
  m = s.match(/^(\d{1,2})\/(\d{1,2})$/);
  if (m) {
    const year = getKRYMD(0).slice(0, 4);
    return `${year}-${String(m[1]).padStart(2, "0")}-${String(m[2]).padStart(2, "0")}`;
  }

  return s; // ë§ˆì§€ë§‰ fallback
}

// âœ… Iì—´ì—ì„œ 20/40 íŒë³„
function getPt(v) {
  const s = norm(v);
  const head2 = s.replace(/[^0-9]/g, "").slice(0, 2);
  if (head2 === "20") return "20";
  if (head2 === "40") return "40";
  return "";
}

const today = getKRYMD(0);
const tomorrow = getKRYMD(1);

const sapDocRows = hub.sources.sap_doc?.rows || [];

// ì¹´ìš´í„°
let t20 = 0, t40 = 0, tLcl = 0;
let m20 = 0, m40 = 0, mLcl = 0;

// ğŸ” (ë””ë²„ê·¸ìš©) ì˜¤ëŠ˜/ë‚´ì¼ í™•ì¸
console.log("[KST] today/tomorrow =", today, tomorrow);
console.log("[sap_doc rows] =", sapDocRows.length);

for (const r of sapDocRows) {
  const shipDate = toYMD(r[COL_SHIP_DATE]);
  const cls = norm(r[COL_CLASSIFY]);

  // í—¤ë” ì œê±°(ì¶œê³ ì¼/ë¶„ë¥˜ ê°™ì€ ê¸€ìë©´ ìŠ¤í‚µ)
  if (!shipDate || shipDate.includes("ì¶œê³ ")) continue;

  // ì˜¤ëŠ˜
  if (shipDate === today) {
    if (cls === "ìˆ˜ì¶œ ì‘ì—…ì˜ë¢°ì„œ") {
      const pt = getPt(r[COL_TYPE]);
      if (pt === "20") t20++;
      else if (pt === "40") t40++;
    } else if (cls === "ë°°ì†¡ ì˜ë¢°ì„œ") {
      tLcl++;
    }
  }

  // ë‚´ì¼
  if (shipDate === tomorrow) {
    if (cls === "ìˆ˜ì¶œ ì‘ì—…ì˜ë¢°ì„œ") {
      const pt = getPt(r[COL_TYPE]);
      if (pt === "20") m20++;
      else if (pt === "40") m40++;
    } else if (cls === "ë°°ì†¡ ì˜ë¢°ì„œ") {
      mLcl++;
    }
  }
}

// í•©ê³„
const tExp = t20 + t40;
const mExp = m20 + m40;

// í™”ë©´ ë°˜ì˜
setText("k_today_20", t20);
setText("k_today_40", t40);
setText("k_today_exp", tExp);
setText("k_today_lcl", tLcl);

setText("k_tom_20", m20);
setText("k_tom_40", m40);
setText("k_tom_exp", mExp);
setText("k_tom_lcl", mLcl);

// ğŸ” (ë””ë²„ê·¸ìš©) ê²°ê³¼ í™•ì¸
console.log("[result] today:", { t20, t40, tExp, tLcl }, "tomorrow:", { m20, m40, mExp, mLcl });
console.log("sources keys:", Object.keys(hub.sources));
console.log("repair exists?", !!hub.sources.repair, "rows:", hub.sources.repair?.rows?.length);


/* ==========================
   âœ… ë³´ìˆ˜ ì‘ì—…ëŸ‰ : sap_item
   - Eì—´: ë‚ ì§œ
   - Rì—´: ê°’(ì¥ìˆ˜)
   - í•œêµ­ì‹œê°„ ê¸°ì¤€ ì›”ë³„ í•©ê³„
   - í˜„ì¬ì›”(í°ìˆ«ì) + ìµœê·¼ 2ê°œì›” ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
========================== */

const COL_REPAIR_DATE = 4;   // E
const COL_REPAIR_VAL  = 17;  // R

const KST_YMD_FMT = new Intl.DateTimeFormat("en-CA", {
  timeZone: "Asia/Seoul",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
});

function getKRYMD2(offsetDays = 0) {
  return KST_YMD_FMT.format(new Date(Date.now() + offsetDays * 86400_000));
}
function toYMD2(s) {
  s = String(s ?? "").replace(/\r/g, "").trim();
  if (!s) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  let m = s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})$/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

  m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
  if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

  m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (m) return `${m[1]}-${m[2]}-${m[3]}`;

  return s;
}
function toNum(v) {
  const s = String(v ?? "").replace(/,/g, "").replace(/[^\d.-]/g, "").trim();
  if (!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

// âœ… YYYY-MM ë§Œë“¤ê¸° / ì›” ì´ë™(ë‹¤ìŒë‹¬)
function ymFromYMD(ymd) { return ymd.slice(0,7); }
function shiftYM(ym, diff) {
  const y = Number(ym.slice(0,4));
  const m = Number(ym.slice(5,7));
  const d = new Date(Date.UTC(y, m - 1 + diff, 1));
  const yy = d.getUTCFullYear();
  const mm = String(d.getUTCMonth() + 1).padStart(2,"0");
  return `${yy}-${mm}`;
}
function monthLabel(ym) {
  return `${Number(ym.slice(5,7))}ì›”`;
}

const ymNow  = ymFromYMD(getKRYMD2(0)); // í˜„ì¬ì›” YYYY-MM
const ymNext = shiftYM(ymNow, +1);      // âœ… ë‹¤ìŒë‹¬ YYYY-MM

const sapItemRows = hub.sources.sap_item?.rows || [];

let sumNow = 0;
let sumNext = 0;

for (const r of sapItemRows) {
  const d = toYMD2(r[COL_REPAIR_DATE]);
  if (!d || d.includes("ë‚ ì§œ")) continue;

  const ym = ymFromYMD(d);
  const val = toNum(r[COL_REPAIR_VAL]);

  if (ym === ymNow) sumNow += val;
  else if (ym === ymNext) sumNext += val;  // âœ… ë‹¤ìŒë‹¬ í•©ê³„
}

const fmtKR = new Intl.NumberFormat("ko-KR");

// âœ… í° ìˆ«ì = í˜„ì¬ì›” í•©ê³„
setText("k_issue", fmtKR.format(sumNow));

// âœ… ì›”ë³„ 2ì¤„ í‘œì‹œ (í˜„ì¬ì›” + ë‹¤ìŒë‹¬)
const listEl = document.getElementById("k_issue_month_list");
if (listEl) {
  listEl.innerHTML = `
    <div>${monthLabel(ymNow)} ${fmtKR.format(sumNow)}</div>
    <div>${monthLabel(ymNext)} ${fmtKR.format(sumNext)}</div>
  `;
}



/* ==========================
   âœ… ë³´ìˆ˜ ì‘ì—… ì§„í–‰ëŸ‰(ì™„ë£Œ) : repair (ìë™ ì»¬ëŸ¼ íƒì§€)
   - ë‚ ì§œ(Aì—´ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‹¤ì œ ë¡œë“œ ë°ì´í„°ì—ì„œ ë‚ ì§œí˜• ì»¬ëŸ¼ ìë™ íƒì§€)
   - ìƒíƒœ("ì™„ë£Œ") ì»¬ëŸ¼ ìë™ íƒì§€
   - ìˆ˜ëŸ‰(Nì—´ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì™„ë£Œ í–‰ì—ì„œ ìˆ«ìê°€ í° ì»¬ëŸ¼ ìë™ íƒì§€)
   - í•œêµ­ì‹œê°„ ê¸°ì¤€: í˜„ì¬ì›” + ë‹¤ìŒë‹¬
========================== */

const ymNow2  = getKRYMD2(0).slice(0, 7);
const ymNext2 = shiftYM(ymNow2, +1);

const repairRows = hub.sources.repair?.rows || [];
console.log("[repair] rows:", repairRows.length);
if (!repairRows.length) {
  setText("k_repair_done", "0");
  const el = document.getElementById("k_repair_done_list");
  if (el) el.innerHTML = `<div>${Number(ymNow2.slice(5,7))}ì›” 0</div><div>${Number(ymNext2.slice(5,7))}ì›” 0</div>`;
} else {

  // ---------- 1) ì»¬ëŸ¼ íƒì§€ ----------
  // 1-1) ë‚ ì§œ ì»¬ëŸ¼: YYYY-MM-DD ë˜ëŠ” YYYY.MM.DD í˜•íƒœê°€ ê°€ì¥ ë§ì´ ë‚˜ì˜¤ëŠ” ì»¬ëŸ¼
  const sampleN = Math.min(200, repairRows.length);
  const colMax = Math.max(...repairRows.slice(0, sampleN).map(r => r.length));

  const isDateLike = (v) => {
    const s = String(v ?? "").trim();
    if (!s) return false;
    return /^\d{4}[-/.]\d{1,2}[-/.]\d{1,2}/.test(s);
  };

  let dateCol = 0;
  let bestDateScore = -1;
  for (let c = 0; c < colMax; c++) {
    let score = 0;
    for (let i = 0; i < sampleN; i++) if (isDateLike(repairRows[i]?.[c])) score++;
    if (score > bestDateScore) { bestDateScore = score; dateCol = c; }
  }

  // 1-2) ìƒíƒœ ì»¬ëŸ¼: "ì™„ë£Œ"ê°€ ê°€ì¥ ë§ì´ ë“±ì¥í•˜ëŠ” ì»¬ëŸ¼
  let statusCol = -1;
  let bestStatusScore = -1;
  for (let c = 0; c < colMax; c++) {
    let score = 0;
    for (let i = 0; i < sampleN; i++) {
      const s = String(repairRows[i]?.[c] ?? "").replace(/\s/g, "");
      if (s.includes("ì™„ë£Œ")) score++;
    }
    if (score > bestStatusScore) { bestStatusScore = score; statusCol = c; }
  }

  // 1-3) ìˆ˜ëŸ‰ ì»¬ëŸ¼: ì™„ë£Œ í–‰ì—ì„œ ìˆ«ì í•©ì´ ê°€ì¥ í° ì»¬ëŸ¼
  let qtyCol = -1;
  let bestQtySum = -1;

  for (let c = 0; c < colMax; c++) {
    let sum = 0;
    for (let i = 0; i < sampleN; i++) {
      const row = repairRows[i];
      const st = String(row?.[statusCol] ?? "").replace(/\s/g, "");
      if (!st.includes("ì™„ë£Œ")) continue;

      const d = toYMD2(row?.[dateCol]);
      if (!d) continue;

      // ì™„ë£Œ í–‰ì—ì„œë§Œ ìˆ«ì í›„ë³´ë¥¼ ëˆ„ì 
      sum += toNum(row?.[c]);
    }
    if (sum > bestQtySum) { bestQtySum = sum; qtyCol = c; }
  }

  console.log("[repair] detected cols => dateCol:", dateCol, "statusCol:", statusCol, "qtyCol:", qtyCol);
  console.log("[repair] sample A/N/R:", repairRows[0]?.[dateCol], repairRows[0]?.[qtyCol], repairRows[0]?.[statusCol]);

  // ---------- 2) ì§‘ê³„ ----------
  let doneNow = 0;
  let doneNext = 0;

  for (const r of repairRows) {
    const d = toYMD2(r?.[dateCol]);
    if (!d || d.includes("ë‚ ì§œ")) continue;

    const ym = d.slice(0, 7);

    const st = String(r?.[statusCol] ?? "").replace(/\r|\n/g, "").replace(/\s/g, "");
    if (!st.includes("ì™„ë£Œ")) continue;

    const qty = toNum(r?.[qtyCol]);
    if (!qty) continue;

    if (ym === ymNow2) doneNow += qty;
    else if (ym === ymNext2) doneNext += qty;
  }

  const fmt = new Intl.NumberFormat("ko-KR");
  setText("k_repair_done", fmt.format(doneNow));

  const listEl = document.getElementById("k_repair_done_list");
  if (listEl) {
    listEl.innerHTML = `
      <div>${Number(ymNow2.slice(5,7))}ì›” ${fmt.format(doneNow)}</div>
      <div>${Number(ymNext2.slice(5,7))}ì›” ${fmt.format(doneNext)}</div>
    `;
  }

  console.log("[repair] result:", { ymNow2, doneNow, ymNext2, doneNext });
}






    /* ==========================
       âœ… ìƒì°¨ì¥ ì¹´ë“œ 4ê°œ ì„¸íŒ… í•¨ìˆ˜
       key: a | m | b1 | b2
       ========================== */
    function setDock(key, info) {
      const done = Number(info.done || 0);
      const total = Number(info.total || 0);
      const pct = total > 0 ? Math.round(done / total * 100) : 0;

      setText(`dock_${key}_done`, done);
      setText(`dock_${key}_total`, total);
      setText(`dock_${key}_pct`, pct);

      setText(`dock_${key}_owner`, info.owner || "-");
      setText(`dock_${key}_inv`, info.inv || "-");
      setText(`dock_${key}_country`, info.country || "-");
      setText(`dock_${key}_pt`, info.pt || "-");
      setText(`dock_${key}_cbm`, info.cbm || "-");
      setText(`dock_${key}_item`, info.item || "-");
      setText(`dock_${key}_time`, info.time || "-");
    }

    // ì§€ê¸ˆì€ ê¸°ë³¸ê°’(ì¶”í›„ ìŠ¤ìº”/ìƒì°¨ CSV ì—°ë™ ì‹œ ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨)
    setDock("a",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("m",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("b1", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("b2", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });

  </script>
</body>
</html>
