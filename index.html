<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>남경 검수시스템 · Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#eef1f5; }
    .no-scrollbar::-webkit-scrollbar{ width:0; height:0; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    /* 공통 KPI */
    .kpi-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .kpi-title{ font-size:12px; color:#64748b; font-weight:700; letter-spacing:.2px; }
    .kpi-value{ margin-top:8px; font-size:28px; font-weight:900; line-height:1; }
    .kpi-desc{ margin-top:6px; font-size:12px; color:#94a3b8; }
    .kpi-warn{ border-color:#fecaca; background:#fff7f7; }

    /* 상차 카드 (전광판 느낌) */
    .dock-card{
      background: linear-gradient(180deg, #0b122a 0%, #111c3f 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:18px;
      box-shadow:0 10px 28px rgba(15,23,42,.20);
    }
    .dock-title{ font-size:13px; color:rgba(255,255,255,.82); font-weight:900; letter-spacing:.3px; }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.88);
      white-space:nowrap;
      font-weight:800;
    }
    .dock-row{ margin-top:10px; display:flex; align-items:end; justify-content:space-between; gap:10px; }
    .dock-percent{ font-size:40px; font-weight:900; line-height:1; letter-spacing:-.6px; }
    .dock-sub{ font-size:13px; color:rgba(255,255,255,.75); font-weight:700; }

    .dock-owner{
      margin-top:10px;
      font-size:18px;            /* ✅ 담당자 크게 */
      font-weight:900;
      letter-spacing:-.2px;
      color:rgba(255,255,255,.95);
    }

    /* ✅ 2x3 배열 */
    .dock-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      font-size:12px;
      color:rgba(255,255,255,.82);
    }
    .dock-grid .k{ color:rgba(255,255,255,.55); font-weight:800; }
    .dock-grid .v{ font-weight:900; color:rgba(255,255,255,.95); }

    /* 오늘/내일 컨테이너 카드 내부 라인 */
    .subline{
      margin-top:6px;
      font-size:12px;
      color:#64748b;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-weight:800;
    }
    .subline span:last-child{ font-variant-numeric: tabular-nums; color:#0f172a; font-weight:900; }
  </style>
</head>

<body class="min-h-screen">
  <script src="nav.js"></script>

  <div class="max-w-[1700px] mx-auto pt-16 px-4 md:px-6 pb-8">
    <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-5">

      <!-- =======================
           Left Sidebar
           ======================= -->
      <aside class="lg:sticky lg:top-[76px] h-fit">
        <div class="bg-[#1f2a58] text-white rounded-2xl overflow-hidden shadow-sm">
          <div class="px-4 py-4 border-b border-white/10">
            <div class="flex items-center gap-2">
              <div class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center font-bold text-sm">NK</div>
              <div class="min-w-0">
                <div class="text-sm font-semibold leading-5 truncate">남경 검수시스템</div>
                <div class="text-[11px] text-white/70">WMS Dashboard</div>
              </div>
            </div>

            <div class="mt-3">
              <div class="text-[11px] text-white/70">데이터 상태</div>
              <div class="mt-1 flex items-center justify-between">
                <span id="dataStatus" class="text-[12px] font-semibold">대기</span>
                <span id="dataUpdated" class="text-[11px] text-white/70">-</span>
              </div>
            </div>
          </div>

          <nav class="px-2 py-2">
            <a href="index.html" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10">
              <span class="text-[12px] font-semibold">DASHBOARD</span>
            </a>

            <a href="index_repair.html" class="mt-1 flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
              <span class="text-[12px]">DASHBOARD-보수</span>
              <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
            </a>

            <div class="mt-2 space-y-1">
              <a href="scan.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">상차 스캔</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-sky-400/20 text-sky-200 border border-sky-300/20">RUN</span>
              </a>

              <a href="IN.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">입고검수</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
              </a>

              <a href="OUT.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">출고검수</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
              </a>

              <a href="index_shipping.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">출고정보</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
              </a>

              <a href="index_stock.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">재고조회</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
              </a>

              <a href="index_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">결품조회</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-rose-400/20 text-rose-200 border border-rose-300/20">ISSUE</span>
              </a>

              <a href="detail_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">전체결품</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">LIST</span>
              </a>

              <a href="index_repair.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">보수작업</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
              </a>
            </div>

            <div class="mt-3 px-3 py-3 border-t border-white/10">
              <div class="text-[11px] text-white/70 leading-5">
                · 전광판 모니터용 구성<br/>
                · 상차 스캔 연동 예정(진행률/인보이스/국가/PT/CBM/품목/시간/담당)
              </div>
            </div>
          </nav>
        </div>
      </aside>

      <!-- =======================
           Main
           ======================= -->
      <main class="min-w-0">

        <div class="flex items-end justify-between gap-3 mb-4">
          <div>
            <div class="text-[12px] text-slate-500 font-semibold tracking-wide">DASHBOARD</div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900">
              상차 진행 현황 · 운영 모니터
            </div>
          </div>
        </div>

        <!-- ✅ 상단 4칸: A / 이동 / B-1 / B-2 (모두 동일 구성) -->
        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-5">

          <!-- A -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">A 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_a_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_a_done">0</span> / <span id="dock_a_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_a_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_a_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_a_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_a_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_a_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_a_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_a_time">-</span></div>
            </div>
          </div>

          <!-- 이동 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">이동 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_m_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_m_done">0</span> / <span id="dock_m_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_m_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_m_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_m_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_m_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_m_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_m_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_m_time">-</span></div>
            </div>
          </div>

          <!-- B-1 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-1 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b1_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b1_done">0</span> / <span id="dock_b1_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_b1_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_b1_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_b1_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b1_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b1_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_b1_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_b1_time">-</span></div>
            </div>
          </div>

          <!-- B-2 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-2 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b2_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b2_done">0</span> / <span id="dock_b2_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_b2_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_b2_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_b2_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b2_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b2_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_b2_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_b2_time">-</span></div>
            </div>
          </div>

        </section>

        <!-- 아래 KPI들은 기존 그대로 써도 됨(필요하면 다시 조정) -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="kpi-card">
            <div class="kpi-title">오늘 컨테이너</div>
            <div class="kpi-value tabular-nums" id="k_today_exp">0</div>
            <div class="subline"><span>20pt</span><span id="k_today_20">0</span></div>
            <div class="subline"><span>40pt</span><span id="k_today_40">0</span></div>
            <div class="kpi-desc">수출 작업의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">오늘 LCL</div>
            <div class="kpi-value tabular-nums" id="k_today_lcl">0</div>
            <div class="kpi-desc">배송 의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">내일 컨테이너</div>
            <div class="kpi-value tabular-nums" id="k_tom_exp">0</div>
            <div class="subline"><span>20pt</span><span id="k_tom_20">0</span></div>
            <div class="subline"><span>40pt</span><span id="k_tom_40">0</span></div>
            <div class="kpi-desc">수출 작업의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">내일 LCL</div>
            <div class="kpi-value tabular-nums" id="k_tom_lcl">0</div>
            <div class="kpi-desc">배송 의뢰서</div>
          </div>
        </section>

        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="kpi-card kpi-warn">
            <div class="kpi-title">보수 작업량</div>
            <div class="kpi-value tabular-nums" id="k_issue">0</div>
            <div class="kpi-desc">당일 발생(임시)</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">보수 작업 진행량</div>
            <div class="kpi-value tabular-nums" id="k_repair_progress">-</div>
            <div class="kpi-desc">진행 / 전체</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">재고</div>
            <div class="kpi-value tabular-nums" id="k_inventory">-</div>
            <div class="kpi-desc">WMS / SAP</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">유통기한</div>
            <div class="kpi-value tabular-nums" id="k_expiry">-</div>
            <div class="kpi-desc">주의 / 위험</div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script type="module">
    import { DataHub } from "./datahub.js";

    const URL_REGISTRY =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=1348530486&single=true&output=csv";

    const MAP_SAPDOC = { dateIdx: 2, typeIdx: 7 };

    function getKRDate(offset = 0) {
      const now = new Date();
      const kr = new Date(now.getTime() + 9 * 3600000 + offset * 86400000);
      return kr.toISOString().slice(0, 10);
    }

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(v);
    };

    const statusEl = document.getElementById("dataStatus");
    const updatedEl = document.getElementById("dataUpdated");

    const hub = await DataHub.loadAll(URL_REGISTRY, (p) => {
      if (!statusEl) return;
      if (p.phase === "registry") {
        statusEl.textContent =
          p.status === "ok" ? `Registry OK (${p.count}개)` :
          p.status === "cached" ? "Registry 캐시 사용" :
          p.status === "loading" ? "Registry 로딩..." : "Registry 오류";
      }
      if (p.phase === "source") {
        if (p.status === "loading") statusEl.textContent = `${p.name} 로딩...`;
        if (p.status === "ok") statusEl.textContent = `${p.name} OK (${p.rows}행)`;
        if (p.status === "error") statusEl.textContent = `${p.name} 오류`;
      }
    });

    const loadedAt = hub.meta.loadedAt.replace("T"," ").slice(0,19);
    if (updatedEl) updatedEl.textContent = loadedAt;

    /* ==========================
   ✅ sap_doc 기반 오늘/내일 출고 집계
   - D열: 출고일 (YYYY-MM-DD)
   - H열: 분류 (수출 작업의뢰서 / 배송 의뢰서)
   - I열: 컨테이너 타입 (앞 2자리 20 / 40)
========================== */

// 컬럼 인덱스 (0부터)
const COL_SHIP_DATE = 3;  // D
const COL_CLASSIFY  = 7;  // H
const COL_TYPE      = 8;  // I

function getKRDateYMD(offsetDays = 0) {
  const now = new Date();
  // 브라우저 로컬이 어디든 상관없이 KST로 맞추기
  const kr = new Date(now.getTime() + 9 * 3600_000 + offsetDays * 86400_000);
  return kr.toISOString().slice(0, 10); // YYYY-MM-DD
}

function norm(s) {
  return String(s ?? "").trim();
}

// I열에서 20/40 판별
function getPtFromI(v) {
  const s = norm(v);
  if (!s) return "";
  const head2 = s.replace(/[^0-9]/g, "").slice(0, 2); // 숫자만 뽑고 앞2자리
  if (head2 === "20") return "20";
  if (head2 === "40") return "40";
  return "";
}

const today = getKRDateYMD(0);
const tomorrow = getKRDateYMD(1);

const sapDocRows = hub.sources.sap_doc?.rows || [];

// 카운터
let t20 = 0, t40 = 0, tLcl = 0;
let m20 = 0, m40 = 0, mLcl = 0;

// 헤더가 있을 수 있으니 "출고일" 같은 헤더면 스킵
for (const r of sapDocRows) {
  const shipDate = norm(r[COL_SHIP_DATE]);
  const cls = norm(r[COL_CLASSIFY]);

  if (!shipDate || shipDate.includes("출고")) continue;

  // 오늘
  if (shipDate === today) {
    if (cls === "수출 작업의뢰서") {
      const pt = getPtFromI(r[COL_TYPE]);
      if (pt === "20") t20++;
      else if (pt === "40") t40++;
      else {
        // pt 정보가 없으면 컨테이너 합계에서만 올리고 싶으면 여기서 처리 가능
        // 지금은 무시(20/40 외 타입은 제외)
      }
    } else if (cls === "배송 의뢰서") {
      tLcl++;
    }
  }

  // 내일
  if (shipDate === tomorrow) {
    if (cls === "수출 작업의뢰서") {
      const pt = getPtFromI(r[COL_TYPE]);
      if (pt === "20") m20++;
      else if (pt === "40") m40++;
    } else if (cls === "배송 의뢰서") {
      mLcl++;
    }
  }
}

// 컨테이너 총합
const tExp = t20 + t40;
const mExp = m20 + m40;

// 화면 반영 (이미 네 HTML에 있는 ID들)
setText("k_today_20", t20);
setText("k_today_40", t40);
setText("k_today_exp", tExp);
setText("k_today_lcl", tLcl);

setText("k_tom_20", m20);
setText("k_tom_40", m40);
setText("k_tom_exp", mExp);
setText("k_tom_lcl", mLcl);


    /* ==========================
       ✅ 상차장 카드 4개 세팅 함수
       key: a | m | b1 | b2
       ========================== */
    function setDock(key, info) {
      const done = Number(info.done || 0);
      const total = Number(info.total || 0);
      const pct = total > 0 ? Math.round(done / total * 100) : 0;

      setText(`dock_${key}_done`, done);
      setText(`dock_${key}_total`, total);
      setText(`dock_${key}_pct`, pct);

      setText(`dock_${key}_owner`, info.owner || "-");
      setText(`dock_${key}_inv`, info.inv || "-");
      setText(`dock_${key}_country`, info.country || "-");
      setText(`dock_${key}_pt`, info.pt || "-");
      setText(`dock_${key}_cbm`, info.cbm || "-");
      setText(`dock_${key}_item`, info.item || "-");
      setText(`dock_${key}_time`, info.time || "-");
    }

    // 지금은 기본값(추후 스캔/상차 CSV 연동 시 여기만 바꾸면 됨)
    setDock("a",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("m",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("b1", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
    setDock("b2", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });

  </script>
</body>
</html>
