<!-- =========================
  index.html 
========================= -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>남경 검수시스템 · Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#eef1f5; }
    .no-scrollbar::-webkit-scrollbar{ width:0; height:0; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    /* 공통 KPI */
    .kpi-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:18px;
      padding:16px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .kpi-title{ font-size:12px; color:#64748b; font-weight:700; letter-spacing:.2px; }
    .kpi-value{ margin-top:8px; font-size:28px; font-weight:900; line-height:1; }
    .kpi-desc{ margin-top:6px; font-size:12px; color:#94a3b8; }
    .kpi-warn{ border-color:#fecaca; background:#fff7f7; }

    /* 상차 카드 (전광판 느낌) */
    .dock-card{
      background: linear-gradient(180deg, #0b122a 0%, #111c3f 100%);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:20px;
      padding:18px;
      box-shadow:0 10px 28px rgba(15,23,42,.20);
    }
    .dock-title{ font-size:13px; color:rgba(255,255,255,.82); font-weight:900; letter-spacing:.3px; }
    .pill{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.88);
      white-space:nowrap;
      font-weight:800;
    }
    .dock-row{ margin-top:10px; display:flex; align-items:end; justify-content:space-between; gap:10px; }
    .dock-percent{ font-size:40px; font-weight:900; line-height:1; letter-spacing:-.6px; }
    .dock-sub{ font-size:13px; color:rgba(255,255,255,.75); font-weight:700; }

    .dock-owner{
      margin-top:10px;
      font-size:18px;
      font-weight:900;
      letter-spacing:-.2px;
      color:rgba(255,255,255,.95);
    }

    /*  2x3 배열 */
    .dock-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      font-size:12px;
      color:rgba(255,255,255,.82);
    }
    .dock-grid .k{ color:rgba(255,255,255,.55); font-weight:800; }
    .dock-grid .v{ font-weight:900; color:rgba(255,255,255,.95); }

    /* 컨테이너 20/40 칩 */
    .subline{
      margin-top:8px;
      font-size:14px;
      color:#0f172a;
      display:flex;
      gap:12px;
      font-weight:900;
    }
    .subline .chip{
      padding:4px 10px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e2e8f0;
      font-variant-numeric: tabular-nums;
    }
    .subline .chip b{ font-weight:900; }
    .subline span:last-child{ font-variant-numeric: tabular-nums; color:#0f172a; font-weight:900; }

    /* 보수 진행량 카드 연초록 */
    .kpi-green{
      border-color:#bbf7d0;
      background:#f0fdf4;
    }

    /*  전광판: 갱신 강조 */
    @keyframes flash {
      0% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.02); filter: brightness(1.15); }
      100% { transform: scale(1); filter: brightness(1); }
    }
    .flash { animation: flash .6s ease-out 1; }
  </style>
</head>

<body class="min-h-screen">

  <!--  기존 nav.js 유지 -->
  <script src="nav.js"></script>

  <div class="max-w-[1700px] mx-auto pt-16 px-4 md:px-6 pb-8">
    <div class="relative">

      <!-- ✅ Overlay -->
      <div id="sidebarOverlay" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

      <!-- =======================
            Sidebar (기본 접힘, 슬라이드)
           ======================= -->
      <aside id="sidebar"
        class="fixed z-50 top-0 left-0 h-full w-[270px] md:w-[290px] lg:w-[300px]
               -translate-x-full transition-transform duration-200 ease-out">
        <div class="h-full pt-16 px-3">
          <div class="bg-[#1f2a58] text-white rounded-2xl overflow-hidden shadow-sm h-[calc(100vh-5rem)]">
            <div class="px-4 py-4 border-b border-white/10">
              <div class="flex items-center gap-2">
                <div class="w-9 h-9 rounded-xl bg-white/10 flex items-center justify-center font-bold text-sm">NK</div>
                <div class="min-w-0">
                  <div class="text-sm font-semibold leading-5 truncate">남경 검수시스템</div>
                  <div class="text-[11px] text-white/70">남경 Dashboard</div>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-[11px] text-white/70">데이터 상태</div>
                <div class="mt-1 flex items-center justify-between">
                  <span id="dataStatus" class="text-[12px] font-semibold">대기</span>
                  <span id="dataUpdated" class="text-[11px] text-white/70">-</span>
                </div>
              </div>
            </div>

            <nav class="px-2 py-2">
              <a href="index.html" class="flex items-center gap-2 px-3 py-2 rounded-xl bg-white/10">
                <span class="text-[12px] font-semibold">DASHBOARD</span>
              </a>

              <a href="index_repair.html" class="mt-1 flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                <span class="text-[12px]">DASHBOARD-보수</span>
                <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
              </a>

              <div class="mt-2 space-y-1">
                <a href="scan.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">상차 스캔</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-sky-400/20 text-sky-200 border border-sky-300/20">RUN</span>
                </a>

                <a href="IN.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">입고검수</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
                </a>

                <a href="OUT.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">출고검수</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-emerald-400/20 text-emerald-200 border border-emerald-300/20">OPEN</span>
                </a>

                <a href="index_shipping.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">출고정보</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
                </a>

                <a href="index_stock.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">재고조회</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">VIEW</span>
                </a>

                <a href="index_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">결품조회</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-rose-400/20 text-rose-200 border border-rose-300/20">ISSUE</span>
                </a>

                <a href="detail_defect.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">전체결품</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-white/10 border border-white/15 text-white/80">LIST</span>
                </a>

                <a href="index_repair.html" class="flex items-center justify-between px-3 py-2 rounded-xl hover:bg-white/10">
                  <span class="text-[12px]">보수작업</span>
                  <span class="text-[10px] px-2 py-0.5 rounded-md bg-amber-400/20 text-amber-200 border border-amber-300/20">WORK</span>
                </a>
              </div>

              <div class="mt-3 px-3 py-3 border-t border-white/10">
                <div class="text-[11px] text-white/70 leading-5">
                  · Dashboard <br/>
                  · 상차 스캔 연동 예정(진행률/인보이스/국가/PT/CBM/품목/시간/담당)
                </div>
              </div>
            </nav>
          </div>
        </div>
      </aside>

      <!-- =======================
           Main (풀폭 Dashboard)
           ======================= -->
      <main class="min-w-0">

        <!--  전광판 상태 바 -->
        <div id="boardBar" class="mb-4 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="text-[11px] font-extrabold text-slate-500 tracking-widest">DISPLAY MODE</div>
              <div class="hidden md:block text-sm font-extrabold text-slate-900 truncate">
                남경 검수시스템 · DASHBOARD
              </div>
            </div>

            <div class="flex items-center gap-3">
              <!--  MENU 버튼 -->
              <button id="btnSidebar"
                class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-[12px] font-extrabold text-slate-800 hover:bg-slate-50">
                MENU
              </button>

              <div class="text-right">
                <div id="boardClock" class="text-lg md:text-xl font-extrabold tabular-nums text-slate-900">--:--:--</div>
                <div class="text-[11px] text-slate-500">
                  마지막 갱신:
                  <span id="boardUpdated" class="font-extrabold text-sky-700">-</span>
                </div>
              </div>

              <button id="btnFullscreen"
                class="hidden md:inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-[12px] font-extrabold text-slate-800 hover:bg-slate-100">
                FULLSCREEN
              </button>
            </div>
          </div>

          <div class="mt-2 flex items-center justify-between">
            <div class="text-[11px] text-slate-500">
              자동 새로고침 <b id="boardEvery">30</b>초 · 다음 갱신까지 <b id="boardCountdown">30</b>초
            </div>
            <div id="boardPulse" class="text-[11px] font-extrabold text-emerald-700">LIVE</div>
          </div>
        </div>

        <div class="flex items-end justify-between gap-3 mb-4">
          <div>
            <div class="text-[12px] text-slate-500 font-semibold tracking-wide">DASHBOARD</div>
            <div class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-900">
              상차 진행 현황 · 보수작업
            </div>
          </div>
        </div>

        <!--  상단 4칸 -->
        <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-5">

          <!-- A -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">A 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_a_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_a_done">0</span> / <span id="dock_a_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_a_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_a_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_a_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_a_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_a_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_a_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_a_time">-</span></div>
            </div>
          </div>

          <!-- 이동 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">이동 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_m_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_m_done">0</span> / <span id="dock_m_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_m_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_m_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_m_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_m_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_m_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_m_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_m_time">-</span></div>
            </div>
          </div>

          <!-- B-1 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-1 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b1_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b1_done">0</span> / <span id="dock_b1_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_b1_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_b1_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_b1_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b1_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b1_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_b1_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_b1_time">-</span></div>
            </div>
          </div>

          <!-- B-2 -->
          <div class="dock-card">
            <div class="flex items-center justify-between">
              <div class="dock-title">B-2 상차 진행현황</div>
              <span class="pill">LIVE</span>
            </div>
            <div class="dock-row">
              <div class="dock-percent"><span id="dock_b2_pct">0</span>%</div>
              <div class="dock-sub"><span id="dock_b2_done">0</span> / <span id="dock_b2_total">0</span></div>
            </div>
            <div class="dock-owner">담당자 - <span id="dock_b2_owner">-</span></div>
            <div class="dock-grid">
              <div><span class="k">인보이스</span> <span class="v" id="dock_b2_inv">-</span></div>
              <div><span class="k">국가</span> <span class="v" id="dock_b2_country">-</span></div>
              <div><span class="k">pt</span> <span class="v" id="dock_b2_pt">-</span></div>
              <div><span class="k">CBM</span> <span class="v" id="dock_b2_cbm">-</span></div>
              <div><span class="k">품목</span> <span class="v" id="dock_b2_item">-</span></div>
              <div><span class="k">상차시간</span> <span class="v" id="dock_b2_time">-</span></div>
            </div>
          </div>

        </section>

        <!-- KPI 1줄 -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="kpi-card">
            <div class="kpi-title">오늘 컨테이너</div>
            <div class="kpi-value tabular-nums" id="k_today_exp">0</div>

            <div class="subline">
              <span class="chip">20pt- <b id="k_today_20">0</b></span>
              <span class="chip">40pt- <b id="k_today_40">0</b></span>
            </div>

            <div class="kpi-desc">수출 작업의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">오늘 LCL</div>
            <div class="kpi-value tabular-nums" id="k_today_lcl">0</div>
            <div class="kpi-desc">배송 의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">내일 컨테이너</div>
            <div class="kpi-value tabular-nums" id="k_tom_exp">0</div>

            <div class="subline">
              <span class="chip">20pt- <b id="k_tom_20">0</b></span>
              <span class="chip">40pt- <b id="k_tom_40">0</b></span>
            </div>

            <div class="kpi-desc">수출 작업의뢰서</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">내일 LCL</div>
            <div class="kpi-value tabular-nums" id="k_tom_lcl">0</div>
            <div class="kpi-desc">배송 의뢰서</div>
          </div>
        </section>

        <!-- KPI 2줄 -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="kpi-card kpi-warn">
            <div class="kpi-title">보수 작업량</div>
            <div class="kpi-value tabular-nums" id="k_issue">0</div>

            <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_issue_month_list">
              <div>1월 0</div>
              <div>2월 0</div>
            </div>
          </div>

          <div class="kpi-card kpi-green">
            <div class="kpi-title">보수 작업 진행량</div>
            <div class="kpi-value tabular-nums" id="k_repair_done">0</div>

            <div class="mt-2 text-[13px] font-extrabold text-slate-700 space-y-1" id="k_repair_done_list">
              <div>1월 0</div>
              <div>2월 0</div>
            </div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">재고</div>
            <div class="kpi-value tabular-nums" id="k_inventory">-</div>
            <div class="kpi-desc">WMS / SAP</div>
          </div>

          <div class="kpi-card">
            <div class="kpi-title">유통기한</div>
            <div class="kpi-value tabular-nums" id="k_expiry">-</div>
            <div class="kpi-desc">주의 / 위험</div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- =========================
        모듈 스크립트 (DataHub + Dashboard 로직)
  ========================== -->
  <script type="module">
    import { DataHub } from "./datahub.js";

    const URL_REGISTRY =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=1348530486&single=true&output=csv";

    const setText = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.textContent = String(v);
    };

    const statusEl = document.getElementById("dataStatus");
    const updatedEl = document.getElementById("dataUpdated");
    const boardUpdatedEl = document.getElementById("boardUpdated");

    function flashUpdated(text) {
      if (updatedEl) updatedEl.textContent = text || "-";
      if (boardUpdatedEl) {
        boardUpdatedEl.textContent = text || "-";
        boardUpdatedEl.classList.remove("flash");
        void boardUpdatedEl.offsetWidth;
        boardUpdatedEl.classList.add("flash");
      }
    }

    /* ==========================
        Sidebar Toggle (Dashboard Mode)
    ========================== */
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");
    const btnSidebar = document.getElementById("btnSidebar");

    function openSidebar() {
      if (!sidebar) return;
      sidebar.classList.remove("-translate-x-full");
      overlay?.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function closeSidebar() {
      if (!sidebar) return;
      sidebar.classList.add("-translate-x-full");
      overlay?.classList.add("hidden");
      document.body.style.overflow = "";
    }

    btnSidebar?.addEventListener("click", () => {
      if (!sidebar) return;
      const isClosed = sidebar.classList.contains("-translate-x-full");
      if (isClosed) openSidebar();
      else closeSidebar();
    });

    overlay?.addEventListener("click", closeSidebar);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSidebar();
    });

    /* ==========================
        공통 유틸
    ========================== */
    function norm(v) {
      return String(v ?? "").replace(/\r/g, "").trim();
    }
    function toNum(v) {
      const s = String(v ?? "").replace(/,/g, "").replace(/[^\d.-]/g, "").trim();
      if (!s) return 0;
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    // KST YYYY-MM-DD
    const KST_FMT = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Seoul",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });
    function getKRYMD(offsetDays = 0) {
      return KST_FMT.format(new Date(Date.now() + offsetDays * 86400_000));
    }

    // 날짜 문자열 → YYYY-MM-DD
    function toYMD(s) {
      s = norm(s);
      if (!s) return "";
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (m) return `${m[1]}-${m[2]}-${m[3]}`;

      m = s.match(/^(\d{4})\.\s*(\d{1,2})\.\s*(\d{1,2})/);
      if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

      m = s.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})/);
      if (m) return `${m[1]}-${String(m[2]).padStart(2,"0")}-${String(m[3]).padStart(2,"0")}`;

      m = s.match(/^(\d{1,2})\/(\d{1,2})$/);
      if (m) {
        const year = getKRYMD(0).slice(0,4);
        return `${year}-${String(m[1]).padStart(2,"0")}-${String(m[2]).padStart(2,"0")}`;
      }
      return s;
    }

    // YYYY-MM
    function ymFromYMD(ymd){ return ymd.slice(0,7); }
    function shiftYM(ym, diff){
      const y = Number(ym.slice(0,4));
      const m = Number(ym.slice(5,7));
      const d = new Date(Date.UTC(y, m - 1 + diff, 1));
      const yy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,"0");
      return `${yy}-${mm}`;
    }
    function monthLabel(ym){ return `${Number(ym.slice(5,7))}월`; }

    const fmtKR = new Intl.NumberFormat("ko-KR");

    /* ==========================
           1) 출고 집계 (sap_doc)
       - D(3): 출고일
       - H(7): 분류
       - I(8): 컨테이너타입(20/40)
    ========================== */
    function calcShipping(hub){
      const COL_SHIP_DATE = 3;
      const COL_CLASSIFY  = 7;
      const COL_TYPE      = 8;

      const today = getKRYMD(0);
      const tomorrow = getKRYMD(1);

      const rows = hub.sources.sap_doc?.rows || [];

      let t20=0,t40=0,tLcl=0;
      let m20=0,m40=0,mLcl=0;

      function getPt(v){
        const s = norm(v);
        const head2 = s.replace(/[^0-9]/g,"").slice(0,2);
        if (head2==="20") return "20";
        if (head2==="40") return "40";
        return "";
      }

      for(const r of rows){
        const shipDate = toYMD(r?.[COL_SHIP_DATE]);
        const cls = norm(r?.[COL_CLASSIFY]);
        if(!shipDate || shipDate.includes("출고")) continue;

        if(shipDate===today){
          if(cls==="수출 작업의뢰서"){
            const pt = getPt(r?.[COL_TYPE]);
            if(pt==="20") t20++;
            else if(pt==="40") t40++;
          } else if(cls==="배송 의뢰서"){
            tLcl++;
          }
        }
        if(shipDate===tomorrow){
          if(cls==="수출 작업의뢰서"){
            const pt = getPt(r?.[COL_TYPE]);
            if(pt==="20") m20++;
            else if(pt==="40") m40++;
          } else if(cls==="배송 의뢰서"){
            mLcl++;
          }
        }
      }

      setText("k_today_20", t20);
      setText("k_today_40", t40);
      setText("k_today_exp", t20+t40);
      setText("k_today_lcl", tLcl);

      setText("k_tom_20", m20);
      setText("k_tom_40", m40);
      setText("k_tom_exp", m20+m40);
      setText("k_tom_lcl", mLcl);
    }

    /* ==========================
           2) 보수 작업량 (sap_item)
       - E(4): 날짜
       - R(17): 장수
       - 현재월 + 다음달
    ========================== */
    function calcIssue(hub){
      const COL_DATE = 4;   // E
      const COL_VAL  = 17;  // R

      const ymNow  = ymFromYMD(getKRYMD(0));
      const ymNext = shiftYM(ymNow, +1);

      const rows = hub.sources.sap_item?.rows || [];

      let sumNow=0, sumNext=0;

      for(const r of rows){
        const d = toYMD(r?.[COL_DATE]);
        if(!d || d.includes("날짜")) continue;
        const ym = ymFromYMD(d);
        const val = toNum(r?.[COL_VAL]);
        if(ym===ymNow) sumNow += val;
        else if(ym===ymNext) sumNext += val;
      }

      setText("k_issue", fmtKR.format(sumNow));

      const listEl = document.getElementById("k_issue_month_list");
      if(listEl){
        listEl.innerHTML = `
          <div>${monthLabel(ymNow)} ${fmtKR.format(sumNow)}</div>
          <div>${monthLabel(ymNext)} ${fmtKR.format(sumNext)}</div>
        `;
      }
    }

    /* ==========================
            3) 보수 작업 진행량(완료) (repair)
       - A(0): 날짜
       - R(17): 상태(완료 포함)
       - N(13): 수량 합
       - 현재월 + 다음달
    ========================== */
    function calcRepair(hub){
      const COL_DATE   = 0;   // A
      const COL_QTY    = 13;  // N
      const COL_STATUS = 17;  // R

      const ymNow  = getKRYMD(0).slice(0,7);
      const ymNext = shiftYM(ymNow, +1);

      const rows = hub.sources.repair?.rows || [];

      let doneNow=0, doneNext=0;

      for(const r of rows){
        const d = toYMD(r?.[COL_DATE]);
        if(!d || d.includes("날짜")) continue;
        const ym = d.slice(0,7);
        if(ym!==ymNow && ym!==ymNext) continue;

        const st = String(r?.[COL_STATUS] ?? "").replace(/\r|\n/g,"").replace(/\s/g,"");
        if(!st.includes("완료")) continue;

        const qty = toNum(r?.[COL_QTY]);
        if(!qty) continue;

        if(ym===ymNow) doneNow += qty;
        else doneNext += qty;
      }

      setText("k_repair_done", fmtKR.format(doneNow));

      const listEl = document.getElementById("k_repair_done_list");
      if(listEl){
        listEl.innerHTML = `
          <div>${Number(ymNow.slice(5,7))}월 ${fmtKR.format(doneNow)}</div>
          <div>${Number(ymNext.slice(5,7))}월 ${fmtKR.format(doneNext)}</div>
        `;
      }
    }

    /* ==========================
           4) 재고 합계 (wms)
       - E(4): 수량 합
    ========================== */
    function calcInventory(hub){
      const COL_QTY = 4; // E
      const rows = hub.sources.wms?.rows || [];
      let sum = 0;

      for(const r of rows){
        if(!r || r.length <= COL_QTY) continue;
        sum += toNum(r[COL_QTY]);
      }

      setText("k_inventory", fmtKR.format(sum));
    }

    /* ==========================
         상차장 카드(임시)
    ========================== */
    function setDock(key, info) {
      const done = Number(info.done || 0);
      const total = Number(info.total || 0);
      const pct = total > 0 ? Math.round(done / total * 100) : 0;

      setText(`dock_${key}_done`, done);
      setText(`dock_${key}_total`, total);
      setText(`dock_${key}_pct`, pct);

      setText(`dock_${key}_owner`, info.owner || "-");
      setText(`dock_${key}_inv`, info.inv || "-");
      setText(`dock_${key}_country`, info.country || "-");
      setText(`dock_${key}_pt`, info.pt || "-");
      setText(`dock_${key}_cbm`, info.cbm || "-");
      setText(`dock_${key}_item`, info.item || "-");
      setText(`dock_${key}_time`, info.time || "-");
    }

    /* ==========================
        데이터 갱신(화면 유지)
    ========================== */
    async function refreshData() {
      try {
        const REG_URL = URL_REGISTRY + (URL_REGISTRY.includes("?") ? "&" : "?") + "t=" + Date.now();

        const hub = await DataHub.loadAll(REG_URL, (p) => {
          if (!statusEl) return;
          if (p.phase === "registry") {
            statusEl.textContent =
              p.status === "ok" ? `Registry OK (${p.count}개)` :
              p.status === "cached" ? "Registry 캐시 사용" :
              p.status === "loading" ? "Registry 로딩..." :
              "Registry 오류";
          }
          if (p.phase === "source") {
            if (p.status === "loading") statusEl.textContent = `${p.name} 로딩...`;
            if (p.status === "ok") statusEl.textContent = `${p.name} OK (${p.rows}행)`;
            if (p.status === "error") statusEl.textContent = `${p.name} 오류`;
          }
        });

        const loadedAt = hub.meta.loadedAt.replace("T"," ").slice(0,19);
        flashUpdated(loadedAt);

        //  값만 업데이트
        calcShipping(hub);
        calcIssue(hub);
        calcRepair(hub);
        calcInventory(hub);

        // 상차카드(임시)
        setDock("a",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
        setDock("m",  { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
        setDock("b1", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });
        setDock("b2", { done:0, total:0, owner:"-", inv:"-", country:"-", pt:"-", cbm:"-", item:"-", time:"-" });

        return hub;
      } catch (e) {
        console.error("refreshData error:", e);
        if (statusEl) statusEl.textContent = "오류: " + (e?.message || e);
        return null;
      }
    }

    /* ==========================
        전광판: 시계 + 폴링(리로드X)
    ========================== */
    const REFRESH_SEC = 30;
    const clockEl = document.getElementById("boardClock");
    const cdEl = document.getElementById("boardCountdown");
    const everyEl = document.getElementById("boardEvery");
    const fsBtn = document.getElementById("btnFullscreen");
    const pulseEl = document.getElementById("boardPulse");

    if (everyEl) everyEl.textContent = String(REFRESH_SEC);

    const KST_TIME_FMT = new Intl.DateTimeFormat("ko-KR", {
      timeZone: "Asia/Seoul",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
    function tickClock(){
      if(clockEl) clockEl.textContent = KST_TIME_FMT.format(new Date());
    }
    tickClock();
    setInterval(tickClock, 1000);

    if (fsBtn) {
      fsBtn.addEventListener("click", async () => {
        try {
          if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
          else await document.exitFullscreen();
        } catch (e) {
          console.warn("fullscreen failed:", e);
        }
      });
    }

    //  최초 1회 로드
    await refreshData();

    //  1초 카운트 + 30초마다 데이터만 갱신
    let remain = REFRESH_SEC;
    if (cdEl) cdEl.textContent = String(remain);

    setInterval(async () => {
      remain--;
      if (remain <= 0) {
        remain = REFRESH_SEC;
        await refreshData(); //  reload 없음
      }
      if (cdEl) cdEl.textContent = String(remain);
      if (pulseEl) pulseEl.style.opacity = (remain % 2 === 0 ? "1" : ".65");
    }, 1000);
  </script>

</body>
</html>
